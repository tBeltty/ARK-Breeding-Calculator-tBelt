name: Deploy to Self-Hosted VPS

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive


      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clean install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy Frontend to Nginx
        # Rsync the build output (dist/) to the web root
        run: rsync -r --delete dist/ /var/www/ark.tbelt.online/html/

      - name: Deploy Bot
        run: |
          rsync -r --delete --exclude 'node_modules' --exclude 'data' --exclude 'tests' ./discord-bot/ /var/www/ark.tbelt.online/bot/
          cd /var/www/ark.tbelt.online/bot
          npm install --production
          pm2 restart ark-bot --update-env
