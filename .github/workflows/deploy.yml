name: Deploy to Self-Hosted VPS

on:
  push:
    branches: [ "main" ]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # GATE: Security & Compliance (blocks deploy)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-and-compliance:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”’ Secret Scan
        run: |
          echo "Scanning repository for hardcoded secrets..."
          FOUND=0

          # Pattern 1: ArkStatus API keys (ark_ prefix + 40+ hex chars)
          if grep -rn 'ark_[a-zA-Z0-9]\{20,\}' --include='*.js' --include='*.jsx' --include='*.ts' --include='*.json' --include='*.yml' --include='*.yaml' --include='*.md' . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::error::LEAKED: ArkStatus API key found in source code!"
            FOUND=1
          fi

          # Pattern 2: Discord tokens (base64-like, 59+ chars with dots)
          if grep -rn '[MN][A-Za-z0-9]\{23,\}\.[A-Za-z0-9_-]\{6,\}\.[A-Za-z0-9_-]\{27,\}' --include='*.js' --include='*.jsx' --include='*.ts' --include='*.json' . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::error::LEAKED: Discord token found in source code!"
            FOUND=1
          fi

          # Pattern 3: Generic API keys/secrets in assignments
          if grep -rn "API_KEY\s*=\s*['\"][a-zA-Z0-9_]\{20,\}['\"]" --include='*.js' --include='*.jsx' --include='*.ts' . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "::error::LEAKED: Hardcoded API key assignment found!"
            FOUND=1
          fi

          # Pattern 4: Temporary test/debug files with real data
          TEST_FILES=$(find . -name 'test_*.js' -o -name 'debug_*.js' -o -name 'tmp_*.js' | grep -v node_modules | grep -v .git || true)
          if [ -n "$TEST_FILES" ]; then
            echo "::error::Prohibited files found (test_*/debug_*/tmp_* scripts): $TEST_FILES"
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "============================================"
            echo "  ðŸš¨ DEPLOY BLOCKED: Secret leak detected"
            echo "  Remove secrets and use .env variables."
            echo "============================================"
            exit 1
          fi

          echo "âœ… Secret scan passed â€” no hardcoded credentials found."

      - name: ðŸ“‹ Guidelines Compliance
        run: |
          echo "Checking project guidelines compliance..."
          VIOLATIONS=0

          # Rule 1: Version sync â€” both package.json files must have the same version
          ROOT_VER=$(node -p "require('./package.json').version" 2>/dev/null)
          BOT_VER=$(node -p "require('./discord-bot/package.json').version" 2>/dev/null)
          if [ "$ROOT_VER" != "$BOT_VER" ]; then
            echo "::error::VERSION MISMATCH: package.json ($ROOT_VER) â‰  discord-bot/package.json ($BOT_VER)"
            VIOLATIONS=$((VIOLATIONS + 1))
          else
            echo "  âœ“ Versions synced: $ROOT_VER"
          fi

          # Rule 2: No nested git repos (submodule incident)
          NESTED_GIT=$(find . -name '.git' -mindepth 2 -not -path './node_modules/*' 2>/dev/null || true)
          if [ -n "$NESTED_GIT" ]; then
            echo "::error::NESTED GIT REPO found: $NESTED_GIT â€” Flatten per CONTEXT.md rules."
            VIOLATIONS=$((VIOLATIONS + 1))
          else
            echo "  âœ“ No nested git repositories"
          fi

          # Rule 3: No src_new directory (legacy structure)
          if [ -d "src_new" ]; then
            echo "::error::LEGACY DIRECTORY 'src_new' still exists â€” must use 'src/' only."
            VIOLATIONS=$((VIOLATIONS + 1))
          else
            echo "  âœ“ No legacy directories"
          fi

          # Rule 4: .env files must not be tracked in git
          if git ls-files --cached | grep -q '\.env$'; then
            echo "::error::.env file is tracked in git! Remove with: git rm --cached .env"
            VIOLATIONS=$((VIOLATIONS + 1))
          else
            echo "  âœ“ No .env files tracked in git"
          fi

          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "============================================"
            echo "  ðŸš¨ DEPLOY BLOCKED: $VIOLATIONS violation(s)"
            echo "  Fix issues above before deploying."
            echo "============================================"
            exit 1
          fi

          echo "âœ… All compliance checks passed."

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # DEPLOY: Only runs if gate passes
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-deploy:
    needs: security-and-compliance
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clean install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          VITE_DISCORD_CLIENT_ID: ${{ secrets.VITE_DISCORD_CLIENT_ID }}

      - name: Deploy Frontend to Nginx
        run: rsync -r --delete dist/ /var/www/ark.tbelt.online/html/

      - name: Deploy Bot
        run: |
          rsync -r --delete --exclude 'node_modules' --exclude 'data' --exclude 'tests' --exclude '.env' ./discord-bot/ /var/www/ark.tbelt.online/bot/
          cd /var/www/ark.tbelt.online/bot
          npm install --production
          pm2 restart ark-bot --update-env || pm2 start src/index.js --name ark-bot

      - name: Verify Bot Environment
        run: |
          echo "Checking required environment variables in production .env..."
          ENV_FILE="/var/www/ark.tbelt.online/bot/.env"
          REQUIRED_VARS=("DISCORD_TOKEN" "DISCORD_CLIENT_ID" "NODE_ENV" "API_PORT" "ARK_STATUS_API_KEY")
          MISSING=()
          for var in "${REQUIRED_VARS[@]}"; do
            if ! grep -q "^${var}=" "$ENV_FILE" 2>/dev/null; then
              MISSING+=("$var")
            fi
          done
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "::error::CRITICAL: Missing required env vars in production .env: ${MISSING[*]}"
            echo "The bot WILL malfunction without these. Add them to $ENV_FILE on the VPS."
            exit 1
          fi
          echo "âœ… All required environment variables present."

      - name: Verify Bot Health
        run: |
          echo "Waiting 8s for bot to initialize..."
          sleep 8
          RESPONSE=$(curl -sf http://localhost:3005/api/stats 2>/dev/null)
          if [ $? -ne 0 ]; then
            echo "::error::Bot API is not responding on port 3005!"
            pm2 logs ark-bot --lines 20 --nostream
            exit 1
          fi
          echo "Bot API response: $RESPONSE"
          DISCORD_READY=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('discord_ready', False))" 2>/dev/null)
          VERSION=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('version', 'unknown'))" 2>/dev/null)
          echo "Bot version: $VERSION | Discord ready: $DISCORD_READY"
          if [ "$DISCORD_READY" != "True" ]; then
            echo "::warning::Discord connection not ready yet (may still be initializing)"
          fi
          echo "âœ… Bot health check passed."
